<template>
    <div class="bg-gray-200 w-full h-full overflow-y-auto">
        <div class="w-full h-[65px] bg-gray-100 mt-2 flex items-center justify-between px-5 shadow-lg">
        <h1 class="font-amaticBold font-extraLight text-3xl">
            Outfit Packages
        </h1>
        </div>
    
        <div class="flex flex-row items-center m-5 space-x-5">
        <div class="flex justify-start w-52 h-20 bg-white rounded-lg shadow-lg px-2 items-center border-l-2 border-green-400 space-x-5">
            <img class="w-auto h-12" src="/img/wardrobes.png" alt="Vendor Image">
            <h2 class="font-amaticRegular text-4xl font-bold mb-0"> {{ totalOutfitPackages }} <span class = "text-sm antialiased text-gray-600">packages</span></h2>
        </div>
    </div>
    
                <div class="flex flex-row justify-between items-center m-5 my-7">
                <div class = "flex">
                <button class = "mr-2 w-44 h-10 bg-[#9B111E] font-semibold text-gray-100 font-quicksand rounded-full shadow-lg 
                transition-transform duration-300 transform hover:scale-105" @click="addOutfitsPackageBtn">
                + Add Outfit Package
                </button>
                </div>
              </div>
    
            <!-- Gown Packages Table -->
                <div v-if="showTable === 'GownPackages'" class="relative shadow-md sm:rounded-xl w-[1170px] h-[200] ml-5 mt-2 font-amaticBold mb-10">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400 mb-4 max-h-30">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-2 py-3">#</th>
                                    <th scope="col" class="px-2 py-3">Package Name</th>
                                    <th scope="col" class="px-2 py-3">Description</th>
                                    <th scope="col" class="px-2 py-3">Price</th>
                                    <th scope="col" class="px-2 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr
                                    v-for="(gownPackage, index) in paginatedGownPackages"
                                    :key="gownPackage.gown_package_id"
                                    class="border-b dark:border-gray-700 odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800">
                                    <th scope="row" class="px-2 py-3 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ gownPackage.dummyIndex }}</th>
                                    <td class="px-1 py-3 hidden sm:table-cell">{{ gownPackage.gown_package_name }}</td>
                                    <td class="px-1 py-3 hidden sm:table-cell">{{ gownPackage.description }}</td>
                                    <td class="px-1 py-3 hidden sm:table-cell">{{ gownPackage.gown_package_price }}</td>
                                    <td class="px-1 py-3 hidden sm:table-cell">
                                        <button
                                            class="h-8 w-12 bg-[#9B111E] font-amaticBold font-medium text-sm rounded-md text-white hover:bg-[#B73A45]"
                                            @click="editGownPackageBtn(index)">
                                            Edit
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Pagination Controls -->
                        <div class="flex justify-center space-x-2 mt-4 mb-6">
                            <button @click="prevGownPackagePage" :disabled="currentGownPackagePage === 1"
                                class="px-3 py-1 bg-[#9B111E] text-white rounded-md hover:bg-[#B73A45] disabled:opacity-50 text-md">Previous</button>
                            <button v-for="page in totalGownPackagePages" :key="page" @click="changeGownPackagePage(page)"
                                :class="{'bg-[#9B111E]': currentGownPackagePage === page, 'bg-gray-300': currentGownPackagePage !== page}"
                                class="px-3 py-1 text-white rounded-md hover:bg-[#B73A45] text-xs">
                                {{ page }}
                            </button>
                            <button @click="nextGownPackagePage" :disabled="currentGownPackagePage === totalGownPackagePages"
                                class="px-3 py-1 bg-[#9B111E] text-white rounded-md hover:bg-[#B73A45] disabled:opacity-50 text-xs">Next</button>
                        </div>
                    </div>
                </div>

    
         
      
              
                <!-- Add Outfit Package Form -->
                <form @submit.prevent="addGownPackage" v-if="addOutfitsPackageForm" @click.self="closeAddGownPackageForm" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center overflow-y-auto z-50">
                    <div class="bg-white w-full max-w-lg p-6 rounded-lg shadow-xl transform transition duration-300 relative">
                    <!-- Close Button -->
                    <button 
                        @click="closeAddGownPackageForm()" 
                        class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 transition duration-300"
                        aria-label="Close form"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>

                    <!-- Header -->
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 text-center">Add Gown Package</h2>
                    </div>

                    <!-- Error Message -->
                    <div v-if="errorMessage" class="text-sm text-red-500 mb-4 text-center">
                        {{ errorMessage }}
                    </div>

                    <!-- Gown Package Name -->
                    <div class="mb-4">
                        <input
                        id="gown-package-name"
                        type="text"
                        v-model="newGownPackage.gown_package_name"
                        class="mt-2 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                        placeholder="Enter package name"
                        required
                        />
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <input
                        id="description"
                        type="text"
                        v-model="newGownPackage.description"
                        class="mt-2 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                        placeholder="Enter description"
                        />
                    </div>

                    <!-- Gowns Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Select Gowns</h3>
                        <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg">
                        <table class="w-full">
                            <thead class="bg-gray-200">
                            <tr>
                                <th class="p-2 text-left">Select</th>
                                <th class="p-2 text-left">Gown Name</th>
                                <th class="p-2 text-left">Price</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr 
                                v-for="outfit in gowns" 
                                :key="outfit.outfit_id" 
                                class="hover:bg-gray-100"
                            >
                                <td class="p-2 text-center">
                                    <input 
                                        type="checkbox" 
                                        :value="outfit.outfit_id"
                                        :checked="selectedGowns.includes(outfit.outfit_id)"
                                        @change="toggleSelection(outfit.outfit_id, 'gown')"
                                        class="form-checkbox h-5 w-5 text-blue-600"
                                    >
                                </td>
                                <td class="p-2 text-sm">{{ outfit.outfit_name }}</td>
                                <td class="p-2 text-sm">{{ formatPrice(outfit.rent_price) }} php</td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Tuxedos Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Select Tuxedos</h3>
                        <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg">
                        <table class="w-full">
                            <thead class="bg-gray-200">
                            <tr>
                                <th class="p-2 text-left">Select</th>
                                <th class="p-2 text-left">Tuxedo Name</th>
                                <th class="p-2 text-left">Price</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr 
                                v-for="outfit in tuxedos" 
                                :key="outfit.outfit_id" 
                                class="hover:bg-gray-100"
                            >
                                <td class="p-2 text-center">
                                <input 
                                    type="checkbox" 
                                    :value="outfit.outfit_id"
                                    :checked="selectedTuxedos.includes(outfit.outfit_id)"
                                    @change="toggleSelection(outfit.outfit_id, 'tuxedo')"
                                    class="form-checkbox h-5 w-5 text-blue-600"
                                >
                                </td>
                                <td class="p-2 text-sm">{{ outfit.outfit_name }}</td>
                                <td class="p-2 text-sm">{{ formatPrice(outfit.rent_price) }} php</td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-end space-x-4">
                        <button
                        @click="closeAddGownPackageForm"
                        type="button"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-400 transition duration-300"
                        >
                        Cancel
                        </button>
                        <button
                        type="submit"
                        class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700 transition duration-300"
                        >
                        Add Package
                        </button>
                    </div>
                    </div>
                </form>



            
            
            <!-- Edit Outfit Package Form -->
                <form v-if="editGownPackageForm" @submit.prevent="updateGownPackage" class="fixed inset-0 bg-black bg-opacity-30 flex justify-center items-center overflow-y-auto z-50">
                <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl transform transition duration-300">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Edit Gown Package</h2>
                    <button @click="closeEditGownPackageForm" class="text-red-500 hover:text-red-700 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    </div>

                    <!-- Error Message -->
                    <div v-if="errorMessage" class="text-sm text-red-500 mb-4">
                    {{ errorMessage }}
                    </div>

                    <!-- Gown Package Name -->
                    <div class="mb-4">
                    <input
                        id="gown-package-name"
                        type="text"
                        v-model="selectedGownPackage.gown_package_name"
                        class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                        placeholder="Enter package name"
                        required
                    />
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                    <input
                        id="description"
                        type="text"
                        v-model="selectedGownPackage.description"
                        class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                        placeholder="Enter description"
                    />
                    </div>

                   <!-- Gowns Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Select Gowns</h3>
                        <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg">
                        <table class="w-full">
                            <thead class="bg-gray-200">
                            <tr>
                                <th class="p-2 text-left">Select</th>
                                <th class="p-2 text-left">Gown Name</th>
                                <th class="p-2 text-left">Price</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr 
                                v-for="outfit in gowns" 
                                :key="outfit.outfit_id" 
                                class="hover:bg-gray-100"
                            >
                                <td class="p-2 text-center">
                                    <input 
                                        type="checkbox" 
                                        :value="outfit.outfit_id"
                                        :checked="selectedGownPackage.selectedGowns.includes(outfit.outfit_id)"
                                        @change="toggleSelection(outfit.outfit_id, 'gown')"
                                        class="form-checkbox h-5 w-5 text-blue-600"
                                    >
                                </td>
                                <td class="p-2 text-sm">{{ outfit.outfit_name }}</td>
                                <td class="p-2 text-sm">{{ formatPrice(outfit.rent_price) }} php</td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Tuxedos Section -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Select Tuxedos</h3>
                        <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg">
                        <table class="w-full">
                            <thead class="bg-gray-200">
                            <tr>
                                <th class="p-2 text-left">Select</th>
                                <th class="p-2 text-left">Tuxedo Name</th>
                                <th class="p-2 text-left">Price</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr 
                                v-for="outfit in tuxedos" 
                                :key="outfit.outfit_id" 
                                class="hover:bg-gray-100"
                            >
                                <td class="p-2 text-center">
                                    <input 
                                        type="checkbox" 
                                        :value="outfit.outfit_id"
                                        :checked="selectedGownPackage.selectedTuxedos.includes(outfit.outfit_id)"
                                        @change="toggleSelection(outfit.outfit_id, 'tuxedo')"
                                        class="form-checkbox h-5 w-5 text-blue-600"
                                    >
                                </td>
                                <td class="p-1 text-sm">{{ outfit.outfit_name }}</td>
                                <td class="p-1 text-sm">{{ formatPrice(outfit.rent_price) }} php</td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-end space-x-4">
                    <button
                        @click="closeEditGownPackageForm"
                        type="button"
                        class="px-4 py-2 bg-red-300 text-gray-700 rounded-lg shadow-sm hover:bg-red-500 transition duration-300"
                    >
                        Delete
                    </button>
                    <button
                        type="submit"
                        class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-600 transition duration-300"
                    >
                        Save Changes
                    </button>
                    </div>
                </div>
            </form>

    
    
          
    
    
    
    
    </div>
    </template>
    
    <script>
    import axios from 'axios';
    
    
    axios.defaults.withCredentials = true;
    
    export default {
        name: 'AddOutfitPackage',
        data() {
            return {
            showTable: 'GownPackages',
            currentGownPackagePage: 1,
            rowsPerGownPackagePage: 5,
            editGownPackageForm: false,
            newGownPackage: {
                gown_package_name: '',
                description: '',
                outfits: []
            },
            gownPackages: [],
            addOutfitsPackageForm: false,
            gowns: [],
            tuxedos: [],
            errorMessage: '',
            selectedGowns: [],
            selectedTuxedos: [],
            selectedGownPackage: {
                gown_package_id: null,
                gown_package_name: '',
                description: '',
                selectedGowns: [],
                selectedTuxedos: []
            },

        };
    },

     computed: {
        totalOutfitPackages() {
            return this.gownPackages.length;
        },
        paginatedGownPackages() {
            const start = (this.currentGownPackagePage - 1) * this.rowsPerGownPackagePage;
            const end = start + this.rowsPerGownPackagePage;
            return this.gownPackages.slice(start, end);
        },
        totalGownPackagePages() {
            return Math.ceil(this.gownPackages.length / this.rowsPerGownPackagePage);
        },
    },
    methods: {
        async fetchGownPackages() {
        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('You are not logged in. Please log in to view gown packages.');
                return;
            }

            const response = await axios.get('http://127.0.0.1:5000/gown-packages', {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                withCredentials: true,
            });

            // Populate gownPackages array with data from API
            this.gownPackages = response.data.map((item, index) => ({
                gown_package_id: item.gown_package_id,
                gown_package_name: item.gown_package_name,
                gown_package_price: item.gown_package_price,
                description: item.description,
                dummyIndex: index + 1,
            }));

        } catch (error) {
            console.error('Error fetching gown packages:', error.response?.data || error.message);
        }
    },


    async fetchOutfits() {
            try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('You are not logged in. Please log in to view outfits.');
                return;
            }

            const response = await axios.get('http://127.0.0.1:5000/outfits', {
                headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                },
                withCredentials: true,
            });

            // Populate outfits array with data from API
            this.outfits = response.data.map((item, index) => ({
                outfit_id: item.outfit_id,
                outfit_name: item.outfit_name,
                outfit_type: item.outfit_type,
                outfit_color: item.outfit_color,
                outfit_desc: item.outfit_desc,
                rent_price: item.rent_price,
                status: item.status,
                outfit_img: item.outfit_img,
                size: item.size,
                weight: item.weight,
                dummyIndex: index + 1,
            }));

            // Separate outfits by type
            this.gowns = this.outfits.filter(outfit => outfit.outfit_type === 'Gown');
            this.tuxedos = this.outfits.filter(outfit => outfit.outfit_type === 'Tuxedo');

            } catch (error) {
            console.error('Error fetching outfits:', error.response?.data || error.message);
            }
        },
        addGownOutfits(event) {
            const selectedOptions = Array.from(event.target.selectedOptions).map(option => option.value);
            this.newGownPackage.outfits = [...new Set([...this.newGownPackage.outfits, ...selectedOptions])];
        },
        addTuxedoOutfits(event) {
            const selectedOptions = Array.from(event.target.selectedOptions).map(option => option.value);
            this.newGownPackage.outfits = [...new Set([...this.newGownPackage.outfits, ...selectedOptions])];
        },

    
        async addGownPackage() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('You are not logged in. Please log in to add a gown package.');
                    return;
                }

                // Check if at least one gown or tuxedo is selected
                if (this.selectedGowns.length === 0 && this.selectedTuxedos.length === 0) {
                    this.errorMessage = "Please select at least one gown or tuxedo";
                    return;
                }

                // Combine gowns and tuxedos into a single outfits array
                const outfits = [...this.selectedGowns, ...this.selectedTuxedos];

                // Prepare the package data with combined outfits
                const packageData = {
                    gown_package_name: this.newGownPackage.gown_package_name,
                    description: this.newGownPackage.description,
                    outfits: outfits  // Send as a single array of outfit IDs
                };

                // Log the data to be sent to the server
                console.log('Sending data:', packageData);

                const response = await axios.post('http://127.0.0.1:5000/add-gown-package', packageData, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    withCredentials: true,
                });

                alert('Gown package added successfully');
                
                // Reset selections and form after successful addition
                this.newGownPackage = {
                    gown_package_name: '',
                    description: '',
                };
                this.selectedGowns = [];
                this.selectedTuxedos = [];
                this.addOutfitsPackageForm = false; // Close the form
            } catch (error) {
                console.error('Error adding gown package:', error.response?.data || error.message);
                this.errorMessage = error.response?.data?.message || 'An error occurred. Please try again.';
            }
        },


    
                async deleteVenue(venue_id) {
                    try {
                        if (!confirm('Are you sure you want to delete this venue? This action cannot be undone.')) {
                        return;
                        }
    
                        const token = localStorage.getItem('access_token');
                        if (!token) {
                        alert('You are not logged in. Please log in to delete venues.');
                        return;
                        }
    
                        const response = await axios.delete(`http://127.0.0.1:5000/delete-venue/${venue_id}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                        },
                        });
    
                        if (response.status === 200) {
                        alert('Venue deleted successfully!');
                        // Remove the deleted venue from the venues array
                        this.venues = this.venues.filter(venue => venue.venue_id !== venue_id);
                        this.closeEditVenueForm(); // Optionally close the form
                        } else {
                        alert('Failed to delete venue.');
                        }
                    } catch (error) {
                        console.error('Error deleting venue:', error);
                        if (error.response) {
                        alert(`Error deleting venue: ${error.response.data.message}`);
                        } else {
                        alert('Error deleting venue. Please try again.');
                        }
                    }
                },
    
            
        // Pagination methods
        prevGownPackagePage() {
            if (this.currentGownPackagePage > 1) {
                this.currentGownPackagePage--;
            }
        },
        nextGownPackagePage() {
            if (this.currentGownPackagePage < this.totalGownPackagePages) {
                this.currentGownPackagePage++;
            }
        },
        changeGownPackagePage(page) {
            this.currentGownPackagePage = page;
        },
        editVenueBtn(index) {
            // Handle edit action for venue
            console.log(`Edit venue at index: ${index}`);
        },
    
        addOutfitsPackageBtn()
        {
            this.addOutfitsPackageForm = true;
        },
        closeAddGownPackageForm()
        {
            this.addOutfitsPackageForm = false;
            this.newGownPackage = {};
        },
        toggleSelection(outfitId, type) {
            const selectedArray = type === 'gown' ? this.selectedGowns : this.selectedTuxedos;
            const index = selectedArray.indexOf(outfitId);
            
            if (index > -1) {
                // If already selected, remove it
                selectedArray.splice(index, 1);
            } else {
                // If not selected, add it
                selectedArray.push(outfitId);
            }
        },

        formatPrice(price) {
            if (price === null || price === undefined || typeof price === 'object' || isNaN(price)) {
                return 'N/A'; // Return a fallback if price is invalid
            }
            // Ensure price is treated as a number, round to 2 decimal places, and format with commas
            return parseFloat(price).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            },
            
            editGownPackageBtn(index) {
            const gownPackage = this.gownPackages[index];
            this.selectedGownPackage = {
                gown_package_id: gownPackage.gown_package_id,
                gown_package_name: gownPackage.gown_package_name,
                description: gownPackage.description,
                selectedGowns: [], // You'll need to fetch the actual selected gowns from backend
                selectedTuxedos: [] // You'll need to fetch the actual selected tuxedos from backend
            };
            this.editGownPackageForm = true;
        },

            closeEditGownPackageForm() {
            this.editGownPackageForm = false;
            this.selectedGownPackage = {
                gown_package_name: '',
                description: '',
                gown_ids: [],
                tuxedo_ids: []
            }; // Reset form fields to default
            this.errorMessage = ''; // Clear error messages
            },

    
    
    },
    
        mounted() {
            this.fetchGownPackages();
            this.fetchOutfits();
        },
    
    
    
    }
    
    
    </script>
    
    <style scoped>

    </style>